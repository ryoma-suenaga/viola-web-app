<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIOLA | ams OSRAM Controller</title>
    <style>
        :root { --accent: #ff5e00; --bg: #050505; --card: #141414; --text: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding-bottom: 50px; }
        .header { width: 100%; padding: 30px 0; text-align: center; background: linear-gradient(180deg, #111 0%, transparent 100%); }
        .logo-img { width: 220px; height: auto; margin-bottom: 5px; filter: drop-shadow(0 0 12px rgba(255,94,0,0.3)); }
        h1 { margin: 0; font-size: 0.9rem; letter-spacing: 5px; font-weight: 300; color: #777; text-transform: uppercase; }
        
        #matrix-shell { background: #000; padding: 15px; border-radius: 20px; border: 1px solid #222; box-shadow: 0 10px 40px rgba(0,0,0,1); margin: 15px 0; }
        #matrix { display: grid; grid-template-columns: repeat(8, 30px); gap: 5px; }
        .led { width: 30px; height: 30px; background: #111; border-radius: 4px; position: relative; }
        .led::after { content: ''; position: absolute; inset: 0; border-radius: 4px; filter: blur(5px); opacity: 0.8; background: inherit; }

        .container { width: 92%; max-width: 400px; display: flex; flex-direction: column; gap: 12px; }
        .card { background: var(--card); border-radius: 16px; padding: 18px; border: 1px solid #222; }
        .label { font-size: 0.65rem; color: #555; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; display: block; font-weight: bold; }
        
        button { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 10px; cursor: pointer; transition: 0.2s; font-size: 0.8rem; text-transform: uppercase; }
        button:active { background: var(--accent); color: #000; transform: scale(0.98); }
        .btn-primary { background: var(--accent); color: #fff; border: none; font-weight: bold; width: 100%; box-shadow: 0 4px 12px rgba(255,94,0,0.2); }

        /* CIE Chromaticity Canvas */
        #colorCanvas { width: 100%; height: 180px; border-radius: 10px; background: #000; cursor: crosshair; touch-action: none; margin-bottom: 10px; }
        .battery-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        #battery-text { font-family: monospace; color: var(--accent); font-weight: bold; font-size: 0.8rem; }

        input[type="range"] { width: 100%; accent-color: var(--accent); margin: 8px 0; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <img src="Logo.png" alt="ams OSRAM" class="logo-img">
        <h1>VIOLA MATRIX CONTROLLER</h1>
    </div>

    <div id="matrix-shell"><div id="matrix"></div></div>

    <div class="container">
        <div class="card">
            <div class="battery-bar"><span class="label" style="margin:0;">Hardware Status</span><span id="battery-text">BATTERY: --%</span></div>
            <button class="btn-primary" onclick="initBLE()">Connect Device</button>
        </div>

        <div class="card">
            <span class="label">Solid State Color (Chromaticity)</span>
            <canvas id="colorCanvas"></canvas>
            <div id="hex-display" style="text-align:center; font-family:monospace; font-size:0.8rem; color:var(--accent);">#FF5E00</div>
        </div>

        <div class="card">
            <span class="label">Global Intensity (GCC)</span>
            <input type="range" id="gccRange" min="0" max="255" value="128">
        </div>

        <div class="card">
            <span class="label">Advanced Algorithms</span>
            <div class="grid-2">
                <button onclick="runMode('phoenix')">PHOENIX</button>
                <button onclick="runMode('ocean')">OCEAN</button>
                <button onclick="runMode('pastel')">PASTEL</button>
                <button onclick="runMode('plasma')">PLASMA</button>
                <button onclick="runMode('aurora')">AURORA</button>
                <button onclick="runMode('off')" style="color:#ff4444;">OFF</button>
            </div>
        </div>
    </div>

    <script>
        // --- High-Resolution Perlin Noise ---
        const noise=(()=>{const p=new Uint8Array(512);for(let i=0;i<256;i++)p[i]=i;for(let i=255;i>0;i--){const r=Math.floor(Math.random()*(i+1));[p[i],p[r]]=[p[r],p[i]]}for(let i=0;i<256;i++)p[256+i]=p[i];const fade=t=>t*t*t*(t*(t*6-15)+10);const lerp=(t,a,b)=>a+t*(b-a);const grad=(hash,x,y,z)=>{const h=hash&15,u=h<8?x:y,v=h<4?y:h==12||h==14?x:z;return((h&1)==0?u:-u)+((h&2)==0?v:-v)};return(x,y,z)=>{const X=Math.floor(x)&255,Y=Math.floor(y)&255,Z=Math.floor(z)&255;x-=Math.floor(x);y-=Math.floor(y);z-=Math.floor(z);const u=fade(x),v=fade(y),w=fade(z),A=p[X]+Y,AA=p[A]+Z,AB=p[A+1]+Z,B=p[X+1]+Y,BA=p[B]+Z,BB=p[B+1]+Z;return lerp(w,lerp(v,lerp(u,grad(p[AA],x,y,z),grad(p[BA],x-1,y,z)),lerp(u,grad(p[AB],x,y-1,z),grad(p[BA+1],x-1,y-1,z))),lerp(v,lerp(u,grad(p[AA+1],x,y,z-1),grad(p[BA+1],x-1,y,z-1)),lerp(u,grad(p[AB+1],x,y-1,z-1),grad(p[BB+1],x-1,y-1,z-1))))}})();

        const matrixEl = document.getElementById('matrix'), leds = [];
        let gcc = 0.5, animTimer = null, time = 0;
        let bleChar = null;

        // Init Matrix
        for (let i = 0; i < 64; i++) {
            const led = document.createElement('div');
            led.className = 'led';
            matrixEl.appendChild(led);
            leds.push(led);
        }

        function draw(x, y, r, g, b) {
            const index = y * 8 + x;
            if (leds[index]) {
                const br = gcc;
                leds[index].style.background = `rgb(${Math.floor(r*br)},${Math.floor(g*br)},${Math.floor(b*br)})`;
            }
        }

        // Chromaticity Canvas Implementation
        const canvas = document.getElementById('colorCanvas'), ctx = canvas.getContext('2d');
        function drawPicker() {
            canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
            const gradH = ctx.createLinearGradient(0, 0, canvas.width, 0);
            for(let i=0; i<=360; i+=10) gradH.addColorStop(i/360, `hsl(${i}, 100%, 50%)`);
            ctx.fillStyle = gradH; ctx.fillRect(0, 0, canvas.width, canvas.height);
            const gradV = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradV.addColorStop(0, 'rgba(255,255,255,1)');
            gradV.addColorStop(0.5, 'rgba(255,255,255,0)');
            gradV.addColorStop(0.5, 'rgba(0,0,0,0)');
            gradV.addColorStop(1, 'rgba(0,0,0,1)');
            ctx.fillStyle = gradV; ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        drawPicker();

        canvas.addEventListener('pointermove', e => {
            if(e.buttons !== 1) return;
            const rect = canvas.getBoundingClientRect(), x = e.clientX - rect.left, y = e.clientY - rect.top;
            const data = ctx.getImageData(x, y, 1, 1).data;
            const hex = "#" + ((1 << 24) + (data[0] << 16) + (data[1] << 8) + data[2]).toString(16).slice(1).toUpperCase();
            document.getElementById('hex-display').innerText = hex;
            setStatic(hex);
        });

        function setStatic(hex) {
            stop();
            const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
            for(let i=0; i<64; i++) draw(i%8, Math.floor(i/8), r, g, b);
            sendBLE(0x00, r, g, b);
        }

        function runMode(mode) {
            stop();
            if (mode === 'off') { leds.forEach(l => l.style.background = '#080808'); sendBLE(0xFF,0,0,0); return; }
            animTimer = setInterval(() => {
                time += 0.02;
                for(let y=0; y<8; y++) {
                    for(let x=0; x<8; x++) {
                        if (mode === 'phoenix') {
                            // Upward Burning Algorithm
                            let n = noise(x * 0.4, y * 0.3 + time * 3, time * 0.5);
                            let heat = (n * 0.5 + 0.5) * 255 * (1.1 - y/7);
                            draw(x, y, heat, heat**2.5/255**1.5, heat**4/255**3);
                        } else if (mode === 'ocean') {
                            // Dynamic Water with Foam (White)
                            let w = noise(x*0.3 - time, y*0.3, time*0.2);
                            let amp = Math.sin(x*0.7 + time*2.5 + w*4);
                            let b = (amp*0.5 + 0.5)*200 + 55;
                            if(amp > 0.8) draw(x, y, b, b, b); // Foam highlights
                            else draw(x, y, 0, b*0.4, b);
                        } else if (mode === 'pastel') {
                            // Smooth interpolation
                            let r = (noise(x*0.08, y*0.08, time*0.3) * 0.5 + 0.5) * 255;
                            let g = (noise(x*0.08, y*0.08, time*0.3+10) * 0.5 + 0.5) * 255;
                            let b = (noise(x*0.08, y*0.08, time*0.3+20) * 0.5 + 0.5) * 255;
                            draw(x, y, r, g, b);
                        } else if (mode === 'plasma') {
                            // Circular Expansion + Full Cycle
                            let d = Math.sqrt((x-3.5)**2 + (y-3.5)**2);
                            let ring = (Math.sin(d - time*6) > 0.8) ? 255 : 40;
                            let hue = (time * 50 + d * 20) % 360;
                            if(ring > 40) draw(x, y, ...hsvToRgb(hue, 1, 1));
                            else draw(x, y, 20, 20, 20);
                        } else if (mode === 'aurora') {
                            // Realistic Aurora Curtains
                            let n = noise(x*0.15 + time, y*0.05, time*0.1);
                            let lum = Math.pow(Math.sin(x*0.4 + n*6) * 0.5 + 0.5, 2);
                            let hue = (120 + Math.sin(time)*40) % 360; // Green to Purple transition
                            draw(x, y, ...hsvToRgb(hue, 0.8, lum));
                        }
                    }
                }
            }, 30);
            const m = {phoenix:1, ocean:2, pastel:3, plasma:4, aurora:5}[mode];
            sendBLE(m, 0, 0, 0);
        }

        function hsvToRgb(h, s, v) {
            let r, g, b, i = Math.floor(h / 60), f = h / 60 - i, p = v * (1 - s), q = v * (1 - f * s), t = v * (1 - (1 - f) * s);
            switch (i % 6) {
                case 0: r = v, g = t, b = p; break; case 1: r = q, g = v, b = p; break; case 2: r = p, g = v, b = t; break;
                case 3: r = p, g = q, b = v; break; case 4: r = t, g = p, b = v; break; case 5: r = v, g = p, b = q; break;
            }
            return [r * 255, g * 255, b * 255];
        }

        function stop() { if(animTimer) clearInterval(animTimer); animTimer = null; }
        function updateGCC(v) { gcc = v / 255; if(bleChar) sendBLE(0x06,0,0,0); }

        // BLE placeholder
        async function initBLE() { alert("Simulating BLE Protocol v1.1..."); }
        async function sendBLE(m, r, g, b) { /* Implementation same as Ver 2.5 */ }
    </script>
</body>
</html>
