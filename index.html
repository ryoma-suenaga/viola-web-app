<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIOLA | ams OSRAM Controller</title>
    <style>
        :root { --accent: #ff5e00; --bg: #050505; --card: #141414; --text: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding-bottom: 50px; }
        .header { width: 100%; padding: 30px 0; text-align: center; background: linear-gradient(180deg, #111 0%, transparent 100%); }
        .logo-img { width: 220px; height: auto; margin-bottom: 5px; filter: drop-shadow(0 0 12px rgba(255,94,0,0.3)); }
        h1 { margin: 0; font-size: 0.9rem; letter-spacing: 5px; font-weight: 300; color: #777; text-transform: uppercase; }
        
        #matrix-shell { background: #000; padding: 15px; border-radius: 20px; border: 1px solid #222; box-shadow: 0 10px 40px rgba(0,0,0,1); margin: 15px 0; }
        #matrix { display: grid; grid-template-columns: repeat(8, 30px); gap: 5px; }
        .led { width: 30px; height: 30px; background: #111; border-radius: 4px; position: relative; }
        .led::after { content: ''; position: absolute; inset: 0; border-radius: 4px; filter: blur(5px); opacity: 0.8; background: inherit; }

        .container { width: 92%; max-width: 400px; display: flex; flex-direction: column; gap: 12px; }
        .card { background: var(--card); border-radius: 16px; padding: 18px; border: 1px solid #222; }
        .label { font-size: 0.65rem; color: #555; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; display: block; font-weight: bold; }
        
        button { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 10px; cursor: pointer; transition: 0.2s; font-size: 0.8rem; text-transform: uppercase; }
        button:active { background: var(--accent); color: #000; transform: scale(0.98); }
        .btn-primary { background: var(--accent); color: #fff; border: none; font-weight: bold; width: 100%; box-shadow: 0 4px 12px rgba(255,94,0,0.2); }

        /* Circular Color Picker */
        #picker-container { position: relative; width: 100%; aspect-ratio: 1/1; max-width: 250px; margin: 0 auto 10px; }
        #colorCanvas { width: 100%; height: 100%; border-radius: 50%; cursor: crosshair; touch-action: none; background: #000; }
        #battery-text { font-family: monospace; color: var(--accent); font-weight: bold; font-size: 0.8rem; }

        input[type="range"] { width: 100%; accent-color: var(--accent); margin: 8px 0; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <img src="Logo.png" alt="ams OSRAM" class="logo-img">
        <h1>VIOLA MATRIX CONTROLLER</h1>
    </div>

    <div id="matrix-shell"><div id="matrix"></div></div>

    <div class="container">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span class="label" style="margin:0;">Hardware Status</span>
                <span id="battery-text">BATTERY: --%</span>
            </div>
            <button class="btn-primary" onclick="initBLE()" style="margin-top:10px;">Connect Device</button>
        </div>

        <div class="card">
            <span class="label">Solid State Color</span>
            <div id="picker-container"><canvas id="colorCanvas"></canvas></div>
            <div id="hex-display" style="text-align:center; font-family:monospace; font-size:0.8rem; color:var(--accent);">#FF5E00</div>
        </div>

        <div class="card">
            <span class="label">Global Intensity (GCC)</span>
            <input type="range" id="gccRange" min="0" max="255" value="180" oninput="updateGCC(this.value)">
        </div>

        <div class="card">
            <span class="label">Advanced Algorithms</span>
            <div class="grid-2">
                <button onclick="runMode('phoenix')">PHOENIX</button>
                <button onclick="runMode('ocean')">OCEAN</button>
                <button onclick="runMode('pastel')">PASTEL</button>
                <button onclick="runMode('plasma')">PLASMA</button>
                <button onclick="runMode('aurora')">AURORA</button>
                <button onclick="runMode('off')" style="color:#ff4444;">OFF</button>
            </div>
        </div>
    </div>

    <script>
        const noise=(()=>{const p=new Uint8Array(512);for(let i=0;i<256;i++)p[i]=i;for(let i=255;i>0;i--){const r=Math.floor(Math.random()*(i+1));[p[i],p[r]]=[p[r],p[i]]}for(let i=0;i<256;i++)p[256+i]=p[i];const fade=t=>t*t*t*(t*(t*6-15)+10);const lerp=(t,a,b)=>a+t*(b-a);const grad=(hash,x,y,z)=>{const h=hash&15,u=h<8?x:y,v=h<4?y:h==12||h==14?x:z;return((h&1)==0?u:-u)+((h&2)==0?v:-v)};return(x,y,z)=>{const X=Math.floor(x)&255,Y=Math.floor(y)&255,Z=Math.floor(z)&255;x-=Math.floor(x);y-=Math.floor(y);z-=Math.floor(z);const u=fade(x),v=fade(y),w=fade(z),A=p[X]+Y,AA=p[A]+Z,AB=p[A+1]+Z,B=p[X+1]+Y,BA=p[B]+Z,BB=p[B+1]+Z;return lerp(w,lerp(v,lerp(u,grad(p[AA],x,y,z),grad(p[BA],x-1,y,z)),lerp(u,grad(p[AB],x,y-1,z),grad(p[BA+1],x-1,y-1,z))),lerp(v,lerp(u,grad(p[AA+1],x,y,z-1),grad(p[BA+1],x-1,y,z-1)),lerp(u,grad(p[AB+1],x,y-1,z-1),grad(p[BB+1],x-1,y-1,z-1))))}})();

        const matrixEl = document.getElementById('matrix'), leds = [];
        let gcc = 0.7, animTimer = null, time = 0, lastValidColor = "#FF5E00";
        let bleChar = null;

        for (let i = 0; i < 64; i++) {
            const led = document.createElement('div');
            led.className = 'led';
            matrixEl.appendChild(led);
            leds.push(led);
        }

        function draw(x, y, r, g, b) {
            const index = y * 8 + x;
            if (leds[index]) {
                // Ensure r,g,b are high enough before GCC multiplication
                leds[index].style.background = `rgb(${Math.floor(r*gcc)},${Math.floor(g*gcc)},${Math.floor(b*gcc)})`;
            }
        }

        // Circular Picker Implementation
        const canvas = document.getElementById('colorCanvas'), ctx = canvas.getContext('2d');
        function drawCircularPicker() {
            canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
            const cx = canvas.width/2, cy = canvas.height/2, radius = canvas.width/2;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            for(let a=0; a<360; a++) {
                const startAngle = (a-1)*Math.PI/180, endAngle = (a+1)*Math.PI/180;
                ctx.beginPath(); ctx.moveTo(cx,cy);
                ctx.arc(cx,cy,radius,startAngle,endAngle);
                ctx.closePath();
                const gradient = ctx.createRadialGradient(cx,cy,0,cx,cy,radius);
                gradient.addColorStop(0,'white');
                gradient.addColorStop(1,`hsl(${a},100%,50%)`);
                ctx.fillStyle = gradient; ctx.fill();
            }
        }
        window.addEventListener('load', drawCircularPicker);

        canvas.addEventListener('pointermove', e => {
            if(e.buttons !== 1) return;
            const rect = canvas.getBoundingClientRect(), x = e.clientX - rect.left, y = e.clientY - rect.top;
            const cx = rect.width/2, cy = rect.height/2, dist = Math.sqrt((x-cx)**2 + (y-cy)**2);
            if(dist <= rect.width/2) {
                const data = ctx.getImageData(x, y, 1, 1).data;
                const hex = "#" + ((1 << 24) + (data[0] << 16) + (data[1] << 8) + data[2]).toString(16).slice(1).toUpperCase();
                lastValidColor = hex;
                document.getElementById('hex-display').innerText = hex;
                setStatic(hex);
            }
        });

        function setStatic(hex) {
            stop();
            const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
            for(let i=0; i<64; i++) draw(i%8, Math.floor(i/8), r, g, b);
            sendBLE(0x00, r, g, b);
        }

        function runMode(mode) {
            stop();
            if (mode === 'off') { leds.forEach(l => l.style.background = '#080808'); sendBLE(0xFF,0,0,0); return; }
            animTimer = setInterval(() => {
                time += 0.02;
                for(let y=0; y<8; y++) {
                    for(let x=0; x<8; x++) {
                        if (mode === 'phoenix') {
                            // Enhanced Phoenix: Hotter base, upward propagation
                            let n = noise(x * 0.45, y * 0.2 + time * 3.5, time * 0.4);
                            let heat = (n * 0.5 + 0.5) * 255 * (1.2 - y/6.5);
                            draw(x, y, heat, Math.pow(heat, 2)/200, Math.pow(heat, 3)/50000);
                        } else if (mode === 'ocean') {
                            // Smooth Foam: Dynamic blue-to-white gradient
                            let w = noise(x*0.35 - time, y*0.25, time*0.15);
                            let amp = Math.sin(x*0.6 + time*2.8 + w*4.5);
                            let baseB = (amp*0.5 + 0.5)*180 + 75;
                            let foam = Math.max(0, (amp - 0.4) / 0.6); // 0.0 to 1.0 transition
                            draw(x, y, baseB*foam, baseB*0.4 + baseB*0.6*foam, baseB);
                        } else if (mode === 'pastel') {
                            // Brighter Pastel: Increased base intensity
                            let r = (noise(x*0.07, y*0.07, time*0.25) * 0.5 + 0.5) * 255;
                            let g = (noise(x*0.07, y*0.07, time*0.25+15) * 0.5 + 0.5) * 255;
                            let b = (noise(x*0.07, y*0.07, time*0.25+30) * 0.5 + 0.5) * 255;
                            draw(x, y, r, g, b);
                        } else if (mode === 'plasma') {
                            // Continuous Expansion: Smooth sine wave mapping
                            let d = Math.sqrt((x-3.5)**2 + (y-3.5)**2);
                            let wave = Math.sin(d - time*7) * 0.5 + 0.5; // Smooth 0 to 1
                            let hue = (time * 60 + d * 15) % 360;
                            let [r,g,b] = hsvToRgb(hue, 1, wave * 0.8 + 0.2);
                            draw(x, y, r, g, b);
                        } else if (mode === 'aurora') {
                            let n = noise(x*0.12 + time, y*0.04, time*0.08);
                            let lum = Math.pow(Math.sin(x*0.35 + n*5.5) * 0.5 + 0.5, 2);
                            let hue = (110 + Math.sin(time*0.5)*60) % 360;
                            draw(x, y, ...hsvToRgb(hue, 0.85, lum));
                        }
                    }
                }
            }, 30);
            sendBLE({phoenix:1, ocean:2, pastel:3, plasma:4, aurora:5}[mode], 0, 0, 0);
        }

        function hsvToRgb(h, s, v) {
            let r, g, b, i = Math.floor(h / 60), f = h / 60 - i, p = v * (1 - s), q = v * (1 - f * s), t = v * (1 - (1 - f) * s);
            switch (i % 6) {
                case 0: r = v, g = t, b = p; break; case 1: r = q, g = v, b = p; break; case 2: r = p, g = v, b = t; break;
                case 3: r = p, g = q, b = v; break; case 4: r = t, g = p, b = v; break; case 5: r = v, g = p, b = q; break;
            }
            return [r * 255, g * 255, b * 255];
        }

        function updateGCC(v) { gcc = v / 255; }
        function stop() { if(animTimer) clearInterval(animTimer); animTimer = null; }
        function initBLE() { alert("Simulating BLE Protocol v1.2..."); }
        function sendBLE(m, r, g, b) { /* Communication Logic */ }
    </script>
</body>
</html>
