<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIOLA | ams OSRAM Controller</title>
    <style>
        :root { --accent: #ff5e00; --bg: #050505; --card: #141414; --text: #ffffff; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding-bottom: 50px; }
        .header { width: 100%; padding: 40px 0; text-align: center; background: linear-gradient(180deg, #111 0%, transparent 100%); }
        .logo-img { width: 240px; height: auto; margin-bottom: 10px; filter: drop-shadow(0 0 15px rgba(255,94,0,0.3)); }
        h1 { margin: 0; font-size: 1rem; letter-spacing: 5px; font-weight: 300; color: #777; text-transform: uppercase; }
        
        #matrix-shell { background: #000; padding: 20px; border-radius: 20px; border: 1px solid #222; box-shadow: 0 10px 40px rgba(0,0,0,1); margin: 15px 0; }
        #matrix { display: grid; grid-template-columns: repeat(8, 32px); gap: 6px; }
        .led { width: 32px; height: 32px; background: #111; border-radius: 4px; position: relative; transition: background 0.05s linear; }
        .led::after { content: ''; position: absolute; inset: 0; border-radius: 4px; filter: blur(5px); opacity: 0.8; background: inherit; }

        .container { width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card); border-radius: 16px; padding: 20px; border: 1px solid #222; }
        .label { font-size: 0.7rem; color: #555; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 12px; display: block; font-weight: bold; }
        
        button { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 14px; border-radius: 10px; cursor: pointer; transition: 0.2s; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }
        button:active { background: var(--accent); color: #000; transform: scale(0.98); }
        .btn-primary { background: var(--accent); color: #fff; border: none; font-weight: bold; width: 100%; box-shadow: 0 4px 15px rgba(255,94,0,0.2); }

        /* Battery Display Style */
        .battery-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        #battery-text { font-family: monospace; color: var(--accent); font-weight: bold; }

        input[type="range"] { width: 100%; accent-color: var(--accent); margin: 10px 0; }
        input[type="color"] { width: 100%; height: 50px; border: none; border-radius: 8px; background: none; cursor: pointer; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <img src="Logo.png" alt="ams OSRAM" class="logo-img">
        <h1>VIOLA MATRIX CONTROLLER</h1>
    </div>
    <div id="matrix-shell"><div id="matrix"></div></div>
    <div class="container">
        <div class="card">
            <div class="battery-bar">
                <span class="label" style="margin:0;">Hardware Status</span>
                <span id="battery-text">BATTERY: --%</span>
            </div>
            <button class="btn-primary" onclick="initBLE()" style="margin-top:10px;">Connect Device</button>
        </div>
        <div class="card"><span class="label">Solid State Color</span><input type="color" value="#ff5e00" oninput="setStatic(this.value)"></div>
        <div class="card"><span class="label">Intensity (GCC)</span><input type="range" min="0" max="255" value="128" oninput="updateGCC(this.value)"></div>
        <div class="card"><span class="label">Advanced Algorithms</span>
            <div class="grid-2">
                <button onclick="runMode('phoenix')">PHOENIX</button>
                <button onclick="runMode('ocean')">OCEAN</button>
                <button onclick="runMode('pastel')">PASTEL</button>
                <button onclick="runMode('plasma')">PLASMA</button>
                <button onclick="runMode('aurora')">AURORA</button>
                <button onclick="runMode('off')" style="color: #ff4444;">OFF</button>
            </div>
        </div>
    </div>

    <script>
        // --- Perlin-based Noise for Organic Motion ---
        const noise = (() => {
            const p = new Uint8Array(512);
            for(let i=0; i<256; i++) p[i] = i;
            for(let i=255; i>0; i--) { const r = Math.floor(Math.random() * (i+1)); [p[i], p[r]] = [p[r], p[i]]; }
            for(let i=0; i<256; i++) p[256+i] = p[i];
            const fade = t => t * t * t * (t * (t * 6 - 15) + 10);
            const lerp = (t, a, b) => a + t * (b - a);
            const grad = (hash, x, y, z) => {
                const h = hash & 15;
                const u = h < 8 ? x : y;
                const v = h < 4 ? y : h === 12 || h === 14 ? x : z;
                return ((h & 1) === 0 ? u : -u) + ((h & 2) === 0 ? v : -v);
            };
            return (x, y, z) => {
                const X = Math.floor(x) & 255, Y = Math.floor(y) & 255, Z = Math.floor(z) & 255;
                x -= Math.floor(x); y -= Math.floor(y); z -= Math.floor(z);
                const u = fade(x), v = fade(y), w = fade(z);
                const A = p[X]+Y, AA = p[A]+Z, AB = p[A+1]+Z, B = p[X+1]+Y, BA = p[B]+Z, BB = p[B+1]+Z;
                return lerp(w, lerp(v, lerp(u, grad(p[AA],x,y,z), grad(p[BA],x-1,y,z)), lerp(u, grad(p[AB],x,y-1,z), grad(p[BA+1],x-1,y-1,z))),
                               lerp(v, lerp(u, grad(p[AA+1],x,y,z-1), grad(p[BA+1],x-1,y,z-1)), lerp(u, grad(p[AB+1],x,y-1,z-1), grad(p[BB+1],x-1,y-1,z-1))));
            };
        })();

        const matrixEl = document.getElementById('matrix');
        let leds = [];
        let gcc = 0.5;
        let animTimer = null;
        let time = 0;
        let bleDevice = null, bleChar = null;

        function initMatrix() {
            matrixEl.innerHTML = '';
            leds = [];
            for (let i = 0; i < 64; i++) {
                const led = document.createElement('div');
                led.className = 'led';
                matrixEl.appendChild(led);
                leds.push(led);
            }
        }

        function draw(x, y, r, g, b) {
            const index = y * 8 + x;
            if (leds[index]) {
                const br = gcc;
                leds[index].style.background = `rgb(${Math.floor(r*br)},${Math.floor(g*br)},${Math.floor(b*br)})`;
            }
        }

        function setStatic(hex) {
            stopAnim();
            const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
            for(let i=0; i<64; i++) draw(i%8, Math.floor(i/8), r, g, b);
            sendBLEData(0x00, r, g, b);
        }

        function runMode(mode) {
            stopAnim();
            if (mode === 'off') { leds.forEach(l => l.style.background = '#080808'); sendBLEData(0xFF, 0, 0, 0); return; }
            animTimer = setInterval(() => {
                time += 0.02;
                for(let y=0; y<8; y++) {
                    for(let x=0; x<8; x++) {
                        if (mode === 'phoenix') {
                            let n = noise(x * 0.4, y * 0.3 + time * 2, time * 0.5);
                            let heat = (n * 0.5 + 0.5) * 255;
                            heat = heat * (1.1 - (y / 7));
                            draw(x, y, heat, heat**2/255, heat**3/(255*255));
                        } else if (mode === 'ocean') {
                            let n = noise(x * 0.3 - time, y * 0.3, time * 0.2);
                            let w = Math.sin(x * 0.8 + y * 0.5 + time * 3 + n * 3);
                            let b = (w * 0.5 + 0.5) * 200 + 55;
                            draw(x, y, 0, b * 0.4, b);
                        } else if (mode === 'pastel') {
                            // PASTEL: Smooth gradient distribution across grid
                            let r = (noise(x*0.1, y*0.1, time*0.4) * 0.5 + 0.5) * 255;
                            let g = (noise(x*0.1, y*0.1, time*0.4 + 10) * 0.5 + 0.5) * 255;
                            let b = (noise(x*0.1, y*0.1, time*0.4 + 20) * 0.5 + 0.5) * 255;
                            draw(x, y, r, g, b);
                        } else if (mode === 'plasma') {
                            // PLASMA: Block-based geometric with color cycling
                            let speed = time * 5;
                            let val = (x + y + Math.floor(speed)) % 8 === 0 ? 255 : 30;
                            let r = (Math.sin(time) * 0.5 + 0.5) * 255;
                            let b = (Math.cos(time) * 0.5 + 0.5) * 255;
                            if(val > 30) draw(x, y, r, 0, b);
                            else draw(x, y, 20, 20, 20);
                        } else if (mode === 'aurora') {
                            // AURORA: Shifting vertical curtains of light
                            let n = noise(x * 0.2 + time, time * 0.5, 0);
                            let brightness = (Math.sin(x * 0.5 + n * 5) * 0.5 + 0.5) * 255;
                            draw(x, y, 0, brightness, brightness * 0.5);
                        }
                    }
                }
            }, 33);
            const m = mode === 'phoenix' ? 0x01 : mode === 'ocean' ? 0x02 : mode === 'pastel' ? 0x03 : mode === 'plasma' ? 0x04 : 0x05;
            sendBLEData(m, 0, 0, 0);
        }

        // --- Web Bluetooth Implementation ---
        async function initBLE() {
            try {
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'VIOLA' }],
                    optionalServices: ['battery_service', 0xFF00]
                });
                const server = await bleDevice.gatt.connect();
                
                // Battery Service
                const battSvc = await server.getPrimaryService('battery_service');
                const battChar = await battSvc.getCharacteristic('battery_level');
                battChar.startNotifications();
                battChar.addEventListener('characteristicvaluechanged', (e) => {
                    let level = e.target.value.getUint8(0);
                    document.getElementById('battery-text').innerText = `BATTERY: ${level}%`;
                });

                // Data Service (Custom)
                const dataSvc = await server.getPrimaryService(0xFF00);
                bleChar = await dataSvc.getCharacteristic(0xFF01);
                
                alert("Connected to VIOLA Hardware");
            } catch (e) { console.error(e); }
        }

        async function sendBLEData(mode, r, g, b) {
            if (bleChar) {
                const data = new Uint8Array([mode, r, g, b, Math.floor(gcc * 255)]);
                await bleChar.writeValue(data);
            }
        }

        function updateGCC(v) { gcc = v / 255; if(bleChar) sendBLEData(0x06, 0, 0, 0); }
        function stopAnim() { if(animTimer) clearInterval(animTimer); animTimer = null; }
        window.onload = initMatrix;
    </script>
</body>
</html>
